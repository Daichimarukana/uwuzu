<?php

$serversettings_file = "server/serversettings.ini";
$serversettings = parse_ini_file($serversettings_file, true);

require('db.php');
//Èñ¢Êï∞Âëº„Å≥Âá∫„Åó
//- „É¶„Éº„Ç∂„Éº„Ç®„Éº„Ç∏„Çß„É≥„Éà„Åã„ÇâdeviceÂêç„Å®„Çã„ÇÑ„Å§
require('function/function.php');

// Â§âÊï∞„ÅÆÂàùÊúüÂåñ
$current_date = null;
$message_array = array();
$error_message = array();
$pdo = null;
$stmt = null;
$res = null;
$option = null;

$row["loginid"] = "";
$row["authcode"] = "";

$ruserid = "";
$rpassword = "";


session_name('uwuzu_s_id');
session_set_cookie_params([
    'lifetime' => 0,
    'path' => '/',
    'domain' => '',
    'secure' => true,
    'httponly' => true,
    'samesite' => 'Lax'
]);
session_start();
session_regenerate_id(true);

if( !empty($_SESSION['userid']) ) {
    $userid = $_SESSION['userid'];
}else{
    header("Location: login.php");
	exit;
}
try {

    $option = array(
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::MYSQL_ATTR_MULTI_STATEMENTS => false
    );
    $pdo = new PDO('mysql:charset=utf8mb4;dbname='.DB_NAME.';host='.DB_HOST , DB_USER, DB_PASS, $option);

    $userData = getUserData($pdo, $userid);
} catch(PDOException $e) {

    // Êé•Á∂ö„Ç®„É©„Éº„ÅÆ„Å®„Åç„Ç®„É©„ÉºÂÜÖÂÆπ„ÇíÂèñÂæó„Åô„Çã
    $error_message[] = $e->getMessage();
}

//„É≠„Ç∞„Ç§„É≥Ë™çË®º---------------------------------------------------
blockedIP($_SERVER['REMOTE_ADDR']);
$is_login = uwuzuUserLogin($_SESSION, $_COOKIE, $_SERVER['REMOTE_ADDR'], "user");
if(!($is_login === false)){
	header("Location: /home/");
	exit;
}
//-------------------------------------------------------------
//„Éë„Çπ„ÉØ„Éº„ÉâË©¶Ë°åÂõûÊï∞Âà∂Èôê-------------------------------------------
if (!isset($_SESSION['login_passtry'])) {
    $_SESSION['login_passtry'] = 0;
}
//-------------------------------------------------------------

if( !empty($_POST['btn_submit']) ) {
    if ($_SESSION["login_passtry"] <= 5) {
        $delay = $_SESSION["login_passtry"] * 2;
    } else {
        $delay = min(pow(2, $_SESSION["login_passtry"] - 2), 60);
    }
    sleep($delay);

    $useragent = safetext($_SERVER['HTTP_USER_AGENT']);
    $device = UserAgent_to_Device($useragent);

    $userbackupcode = $_POST['userbackupcode'];

    $options = array(
        // SQLÂÆüË°åÂ§±ÊïóÊôÇ„Å´‰æãÂ§ñ„Çí„Çπ„É´„Éº
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        // „Éá„Éï„Ç©„É´„Éà„Éï„Çß„ÉÉ„ÉÅ„É¢„Éº„Éâ„ÇíÈÄ£ÊÉ≥ÈÖçÂàóÂΩ¢Âºè„Å´Ë®≠ÂÆö
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        // „Éê„ÉÉ„Éï„Ç°„Éº„Éâ„ÇØ„Ç®„É™„Çí‰Ωø„ÅÜÔºà‰∏ÄÂ∫¶„Å´ÁµêÊûú„Çª„ÉÉ„Éà„ÇíÂÖ®„Å¶ÂèñÂæó„Åó„ÄÅ„Çµ„Éº„Éê„ÉºË≤†Ëç∑„ÇíËªΩÊ∏õÔºâ
        // SELECT„ÅßÂæó„ÅüÁµêÊûú„Å´ÂØæ„Åó„Å¶„ÇÇrowCount„É°„ÇΩ„ÉÉ„Éâ„Çí‰Ωø„Åà„Çã„Çà„ÅÜ„Å´„Åô„Çã
        PDO::MYSQL_ATTR_USE_BUFFERED_QUERY => true,
    );

    $dbh = new PDO('mysql:charset=utf8mb4;dbname='.DB_NAME.';host='.DB_HOST , DB_USER, DB_PASS, $options);

    require_once 'authcode/GoogleAuthenticator.php';

    $result = $dbh->prepare("SELECT * FROM account WHERE userid = :userid");

    $result->bindValue(':userid', $userid);
    // SQLÂÆüË°å
    $result->execute();

    if(!(empty($userbackupcode))){
        $row = $result->fetch();
        $backuplogin = false;
        if(mb_strlen($row["backupcode"]) === 32 && mb_strlen($userbackupcode) === 32){
            if($row["backupcode"] === $userbackupcode){
                $backuplogin = true;
            }else{
                $backuplogin = false;
            }
        }else{
            $backuplogin = false;
        }
        
        if($backuplogin === true || uwuzu_password_verify($userbackupcode,$row["backupcode"])){
            $pdo->beginTransaction();
            
            try {
                $touserid = $userid;
                $datetime = date("Y-m-d H:i:s");
                $msg = "„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç≥„Éº„Éâ„Çí‰ΩøÁî®„Åó„É≠„Ç∞„Ç§„É≥„Åï„Çå„Åæ„Åó„ÅüÔºÅ\n„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç≥„Éº„ÉâÂ§âÊõ¥„ÅÆ„Åü„ÇÅ„Å´‰∫åÊÆµÈöéË™çË®º„ÇíÂÜçË®≠ÂÆö„Åô„Çã„Åì„Å®„ÇíÂº∑„Åè„Åä„Åô„Åô„ÇÅ„Åó„Åæ„Åô„ÄÇ\n„Åæ„Åü„ÄÅ„ÇÇ„Åó„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç≥„Éº„Éâ„ÇíÂà©Áî®„Åó„Å¶„É≠„Ç∞„Ç§„É≥„Åó„ÅüË¶ö„Åà„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Äå„Åù„ÅÆ‰ªñ„Äç„Çà„Çä„Çª„ÉÉ„Ç∑„Éß„É≥„Éà„Éº„ÇØ„É≥„ÇíÂÜçÁîüÊàê„Åó„ÄÅË®≠ÂÆöÁîªÈù¢„Çà„Çä„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥„Åó„ÄÅ‰∫åÊÆµÈöéË™çË®º„ÇíÂÜçË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ\n\n„É≠„Ç∞„Ç§„É≥„Åó„ÅüÁ´ØÊú´ : ".$device;
                $title = 'üî¥„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç≥„Éº„Éâ‰ΩøÁî®„ÅÆ„ÅäÁü•„Çâ„Åõüî¥';
                $url = '/settings';
                $userchk = 'none';
                // ÈÄöÁü•Áî®SQL‰ΩúÊàê
                $stmt = $pdo->prepare("INSERT INTO notification (fromuserid, touserid, msg, url, datetime, userchk, title) VALUES (:fromuserid, :touserid, :msg, :url, :datetime, :userchk, :title)");
        
                $stmt->bindParam(':fromuserid', safetext("uwuzu-fromsys"), PDO::PARAM_STR);
                $stmt->bindParam(':touserid', safetext($touserid), PDO::PARAM_STR);
                $stmt->bindParam(':msg', safetext($msg), PDO::PARAM_STR);
                $stmt->bindParam(':url', safetext($url), PDO::PARAM_STR);
                $stmt->bindParam(':userchk', safetext($userchk), PDO::PARAM_STR);
                $stmt->bindParam(':title', safetext($title), PDO::PARAM_STR);

                $stmt->bindParam(':datetime', safetext($datetime), PDO::PARAM_STR);

                // SQL„ÇØ„Ç®„É™„ÅÆÂÆüË°å
                $res = $stmt->execute();

                // „Ç≥„Éü„ÉÉ„Éà
                $res = $pdo->commit();

            } catch(Exception $e) {

                // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„ÅüÊôÇ„ÅØ„É≠„Éº„É´„Éê„ÉÉ„ÇØ
                $pdo->rollBack();
        	}

            clearstatcache();
                                        
            if (isset($_SERVER['HTTP_COOKIE'])) {
                $cookies = explode(';', $_SERVER['HTTP_COOKIE']);
                foreach($cookies as $cookie) {
                    $parts = explode('=', $cookie);
                    $name = trim($parts[0]);
                    setcookie($name, '', time()-1000);
                }
            }

            setcookie('loginid', $userData["loginid"],[
                'expires' => time() + 60 * 60 * 24 * 28,
                'path' => '/',
                'samesite' => 'lax',
                'secure' => true,
                'httponly' => true,
            ]);
        
            $userEncKey = GenUserEnckey($userData["datetime"]);
            $userLoginKey = hash_hmac('sha256', $userData["loginid"], $userEncKey);
            setcookie('loginkey', $userLoginKey,[
                'expires' => time() + 60 * 60 * 24 * 28,
                'path' => '/',
                'samesite' => 'lax',
                'secure' => true,
                'httponly' => true,
            ]);
        
            $_SESSION['userid'] = $userid;
            $_SESSION['loginid'] = $userData["loginid"];
            $_SESSION['loginkey'] = $userLoginKey;
        
            $_SESSION['username'] = $username;
            $_SESSION['password'] = null;
            $_SESSION["login_passtry"] = 0;
        
            // „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂÖà„ÅÆURL„Å∏Ëª¢ÈÄÅ„Åô„Çã
            $url = '/home';
            header('Location: ' . $url, true, 303);
        
            // „Åô„Åπ„Å¶„ÅÆÂá∫Âäõ„ÇíÁµÇ‰∫Ü
            exit;
        }else{
            $_SESSION["login_passtry"]++;
            $error_message[] = "„Åù„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç≥„Éº„Éâ„ÅØ‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ(BACKUPCODE_DAME)";
        }
    }else{

        if($result->rowCount() > 0) {
            $row = $result->fetch();

            if(!(empty($row["encryption_ivkey"])) && (!(mb_strlen($row["authcode"]) === 16))){
                $tousercode = DecryptionUseEncrKey($row["authcode"], GenUserEnckey($row["datetime"]), $row["encryption_ivkey"]);
            }else{
                $tousercode = $row["authcode"];
            }

            $chkauthcode = new PHPGangsta_GoogleAuthenticator();

            $userauthcode = $_POST['usercode'];

            if(empty($userauthcode)){
                $error_message[] = "„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ(AUTHCODE_INPUT_PLEASE)";
            }else{

                $discrepancy = 2;

                $checkResult = $chkauthcode->verifyCode($tousercode, $userauthcode, $discrepancy);
                if ($checkResult) {

                    $pdo->beginTransaction();
                    try {
                        $touserid = $userid;
                        $datetime = date("Y-m-d H:i:s");
                        $msg = "„Ç¢„Ç´„Ç¶„É≥„Éà„Å´„É≠„Ç∞„Ç§„É≥„Åå„ÅÇ„Çä„Åæ„Åó„Åü„ÄÇ\n„ÇÇ„Åó„É≠„Ç∞„Ç§„É≥„Åó„ÅüË¶ö„Åà„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Äå„Åù„ÅÆ‰ªñ„Äç„Çà„Çä„Çª„ÉÉ„Ç∑„Éß„É≥„Éà„Éº„ÇØ„É≥„ÇíÂÜçÁîüÊàê„Åó„ÄÅ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥„Åó„ÄÅ‰∫åÊÆµÈöéË™çË®º„ÇíÂÜçË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n„É≠„Ç∞„Ç§„É≥„Åó„ÅüÁ´ØÊú´ : ".$device;
                        $title = 'üö™„É≠„Ç∞„Ç§„É≥ÈÄöÁü•üö™';
                        $url = '/settings';
                        $userchk = 'none';
                        // ÈÄöÁü•Áî®SQL‰ΩúÊàê
                        $stmt = $pdo->prepare("INSERT INTO notification (fromuserid, touserid, msg, url, datetime, userchk, title) VALUES (:fromuserid, :touserid, :msg, :url, :datetime, :userchk, :title)");
                
                        $stmt->bindParam(':fromuserid', safetext("uwuzu-fromsys"), PDO::PARAM_STR);
                        $stmt->bindParam(':touserid', safetext($touserid), PDO::PARAM_STR);
                        $stmt->bindParam(':msg', safetext($msg), PDO::PARAM_STR);
                        $stmt->bindParam(':url', safetext($url), PDO::PARAM_STR);
                        $stmt->bindParam(':userchk', safetext($userchk), PDO::PARAM_STR);
                        $stmt->bindParam(':title', safetext($title), PDO::PARAM_STR);

                        $stmt->bindParam(':datetime', safetext($datetime), PDO::PARAM_STR);
                
                        // SQL„ÇØ„Ç®„É™„ÅÆÂÆüË°å
                        $res = $stmt->execute();
                
                        // „Ç≥„Éü„ÉÉ„Éà
                        $res = $pdo->commit();
                
                    } catch(Exception $e) {
                
                        // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„ÅüÊôÇ„ÅØ„É≠„Éº„É´„Éê„ÉÉ„ÇØ
                        $pdo->rollBack();
                    }

                    clearstatcache();
                                        
                    if (isset($_SERVER['HTTP_COOKIE'])) {
                        $cookies = explode(';', $_SERVER['HTTP_COOKIE']);
                        foreach($cookies as $cookie) {
                            $parts = explode('=', $cookie);
                            $name = trim($parts[0]);
                            setcookie($name, '', time()-1000);
                        }
                    }

                    setcookie('loginid', $userData["loginid"],[
                        'expires' => time() + 60 * 60 * 24 * 28,
                        'path' => '/',
                        'samesite' => 'lax',
                        'secure' => true,
                        'httponly' => true,
                    ]);
                
                    $userEncKey = GenUserEnckey($userData["datetime"]);
                    $userLoginKey = hash_hmac('sha256', $userData["loginid"], $userEncKey);
                    setcookie('loginkey', $userLoginKey,[
                        'expires' => time() + 60 * 60 * 24 * 28,
                        'path' => '/',
                        'samesite' => 'lax',
                        'secure' => true,
                        'httponly' => true,
                    ]);
                
                    $_SESSION['userid'] = $userid;
                    $_SESSION['loginid'] = $userData["loginid"];
                    $_SESSION['loginkey'] = $userLoginKey;
                
                    $_SESSION['username'] = $username;
                    $_SESSION['password'] = null; 
                    $_SESSION["login_passtry"] = 0;
                
                    // „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂÖà„ÅÆURL„Å∏Ëª¢ÈÄÅ„Åô„Çã
                    $url = '/home';
                    header('Location: ' . $url, true, 303);
                
                    // „Åô„Åπ„Å¶„ÅÆÂá∫Âäõ„ÇíÁµÇ‰∫Ü
                    exit;
                        
                }else {
                    $_SESSION["login_passtry"]++;
                    $error_message[] = '‰∫åÊÆµÈöéË™çË®º„ÅåÂá∫Êù•„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ(AUTHCODE_CHECK_DAME)';
                }
            }
        }else{
            $error_message[] = '„Éá„Éº„Çø„ÅÆÂèñÂæó„ÅåÂá∫Êù•„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ(AUTHCODE_GET_ACCOUNT_NOT_FOUND)';
        }
    }

}

// „Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆÊé•Á∂ö„ÇíÈñâ„Åò„Çã
$pdo = null;

?>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="css/style.css">
<script src="js/jquery-min.js"></script>
<script src="js/unsupported.js"></script>
<script src="js/back.js"></script>
<link rel="apple-touch-icon" type="image/png" href="favicon/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="favicon/icon-192x192.png">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>„É≠„Ç∞„Ç§„É≥ - <?php echo safetext($serversettings["serverinfo"]["server_name"]);?></title>
</head>

<body>

<div class="leftbox">
    <?php if(!empty(safetext($serversettings["serverinfo"]["server_logo_login"]))){ ?>
        <div class="logo">
            <a href="index.php"><img src=<?php echo safetext($serversettings["serverinfo"]["server_logo_login"]);?>></a>
        </div>
    <?php }else{?>
        <div class="logo">
            <a href="index.php"><img src="img/uwuzulogo.svg"></a>
        </div>
    <?php }?>

    <div class="textbox">
        <h1>‰∫åÊÆµÈöéË™çË®º</h1>

        <p>‰∫åÊÆµÈöéË™çË®º„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>

            <?php if( !empty($error_message) ): ?>
                <ul class="errmsg">
                    <?php foreach( $error_message as $value ): ?>
                        <p>„Éª <?php echo $value; ?></p>
                    <?php endforeach; ?>
                </ul>
            <?php endif; ?>

            <form class="formarea" enctype="multipart/form-data" method="post">
                <div>
                    <p>‰∫åÊÆµÈöéË™çË®º„Ç≥„Éº„Éâ</p>
                    <div class="p2">6Ê°Å„ÅÆ„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
                    <input id="profile" type="number" placeholder="123456" class="inbox" name="usercode" value="">
                </div>
                <div>
                    <p>„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç≥„Éº„Éâ</p>
                    <div class="p2">„ÇÇ„Åó‰∫åÊÆµÈöéË™çË®º„ÅåÂá∫Êù•„Å™„ÅÑÂ†¥Âêà„ÅØ32Ê°ÅËã±Êï∞Â≠ó„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
                    <input id="profile" type="text" placeholder="ÈÄöÂ∏∏„ÅØÂÖ•Âäõ„Åó„Å™„Åè„Å¶Â§ß‰∏àÂ§´„Åß„Åô„ÄÇ" class="inbox" name="userbackupcode" value="">
                </div>
                    <input type="submit" class = "irobutton" name="btn_submit" value="Ê¨°„Å∏">
            </form>

            <div class="btnbox">
                <a href="index.php" class="sirobutton">Êàª„Çã</a>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

function checkForm(inputElement) {
    var str = inputElement.value;
    while (str.match(/[^A-Za-z\d_]/)) {
        str = str.replace(/[^A-Za-z\d_]/, "");
    }
    inputElement.value = str;
}
</script>


</body>
</html>